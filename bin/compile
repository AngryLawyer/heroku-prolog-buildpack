#!/bin/bash

##
# usage: bin/compile <build-dir> <cache-dir>

set -e
bpdir=$(cd $(dirname $(dirname $0)); pwd)
mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
test -z ${build} && exit
cache=$(cd "$2/" && pwd)
test -z ${cache} && exit
DEFAULT_SWI_VERSION="master"
if [ -f ${build}/.preferred_swi_version ]; then
    SWI_VERSION=$(cat ${build}/.preferred_swi_version)
fi
ver=${SWI_VERSION:=${DEFAULT_SWI_VERSION}}
tarball=${ver}.tgz
PROFILE=${HOME}/.profile.d



echo "-----> Using SWI Prolog version $ver"
(
    set -e
    unset GIT_DIR
    # Already cached?
    #test -f ${cache}/${ver}-compiled && exit

    rm -rf ${cache}/${ver}
    cd ${cache}
    mkdir ${ver}
    cd ${ver}
    gitver=$(git --version)
    echo "-------> Fetching SWI Prolog ${ver} from git using ${gitver}"
    git clone --branch ${ver} https://github.com/SWI-Prolog/swipl-devel.git
    cd swipl-devel
    echo "-------> Ensuring HTTP"
    echo "-------> Building SWI Prolog $ver in ${cache}/${ver}"
    sed -i -e 's@2.66@2.65@g' src/configure.in
    ./prepare --yes --all --man
    ./configure --with-world --prefix=${build}/swipl-${ver} && make || exit 1
    echo "-------> Installing SWI Prolog $ver"
    make install || exit 1
    touch ${cache}/${ver}-compiled
    echo "-------> Installed SWI Prolog $ver"
)

echo "-----> Found SWI Prolog version $ver ready for use in ${cache}/${ver}"

PATH=${cache}/swipl-${ver}/bin:$PATH
export PATH

cd $build
pwd
swipl="${build}/swipl-${ver}/bin/swipl"
echo ${swipl} -o splunge -c /app/main.pl -g go -t prolog
${swipl} -o splunge -c /app/main.pl -g go -t prolog

echo "-----> Build succeeded"

